<!--
Les commits sur ce sujet sont :

* https://www.postgresql.org/message-id/flat/20220318031244.tu3wwlyxxabzq3iu%40jrouhaud#f6c6c1ae24fdd44e5598312bed8e2760
* https://www.postgresql.org/message-id/E1nVrzX-000Xxn-OQ@gemulon.postgresql.org

* https://www.postgresql.org/message-id/E1nJVyA-0003tZ-IP@gemulon.postgresql.org (db level coll version tracking)

Discussion

* https://www.postgresql.org/message-id/flat/5e756dd6-0e91-d778-96fd-b1bcb06c161a@2ndquadrant.com 

-->

<div class="slide-content">

 * définition des collations ICU pour toute l'instance ou une base de données
 * `initdb` et `createdb`
   + `--locale-provider={icu|libc}`
   + `--icu-locale=LOCALE`
 * `CREATE DATABASE .. LOCALE_PROVIDER [icu,libc] ICU_LOCALE "LOCALE"`

</div>

<div class="notes">

Le support pour l'utilisation des collations ICU a été ajouté en version 10 de
PostgreSQL pour éviter d'être dépendant de la bonne gestion des mises à jour de
la librairie glibc. En effet, un changement de version de glibc qui modifie
l'ordre de certains tris qui peut changer le résultat de `SELECT .. ORDER BY
..` ou l'ordre des clés dans les index. En raison de ce risque de corruption,
une réindexation est nécessaire en cas de restauration ou de promotion d'une
instance secondaire sur un serveur avec une version de glibc différente.

ICU est une librairie qui permet une gestion standardisée des collations. Cela
permet d'éviter les problèmes décrits précédemment en versionnant les
collations et en permettant aux administrateurs de choisir quand/si ils
changent de collation. Elles permettent aussi d'ajouter des fonctionnalités
comme la possibilité d'ordonner les résultats en respectant ou non la casse et
les accents (disponible avec PostgreSQL 12). Pour finir, les collations ICU
permettent à PostgreSQL d'utiliser les _abbreviate keys_ dans les index, ce qui
permet notamment d'accélérer la [création des
index](https://blog.anayrat.info/2017/11/19/postgresql-10-icu-abbreviated-keys/).

La version 10 de PostgreSQL permet de spécifier d'ajouter les collations ICU
aux collations disponibles sur une instance.

```sql
SELECT CASE collprovider 
          WHEN 'i' THEN 'icu' 
	  WHEN 'd' THEN 'default' 
  	  ELSE 'glibc'
       END as collation,
       collversion, count(*)
FROM pg_collation 
GROUP BY collprovider, collversion
ORDER BY collprovider;
```
```sh
 collation | collversion | count
-----------+-------------+-------
 default   | ¤           |     1
 glibc     | ¤           |  1009
 icu       | 153.14      |   461
 icu       | 153.14.39   |   324
(4 rows)
```

L'ajout des collations au catalogue se fait soit lors de la création l'intance
soit grâce à la nouvelle commande `CREATE COLLATION`.

```sql
CREATE COLLATION capitalfirst (PROVIDER=icu, LOCALE='en-u-kf-upper');
```

Si la collation est modifiée le message d'erreur suivant est visible dans les
traces.

```sh
WARNING:  collation "xx-x-icu" has version mismatch
DETAIL:  The collation in the database was created using version 1.2.3.4, but
         the operating system provides version 2.3.4.5.
HINT:  Rebuild all objects affected by this collation and run ALTER COLLATION
       pg_catalog."xx-x-icu" REFRESH VERSION, or build PostgreSQL with the
       right library version.
```

En version 10, Le choix de la collation ICU ne peut être spécifiée que par
objet, ce qui rend cette fonctionnalité difficile à utiliser.

Exemple:

```sql
CREATE TABLE t1 (t text COLLATE "en-US-x-icu");
ALTER TABLE t1 ALTER textcol TYPE text COLLATE "fr-FR-x-icu";
```

La version 13 ajoute la possibilité de versionner les collations fournies par
la glibc avec la version de cette librairie.

```sh
 collation | collversion | count 
-----------+-------------+-------
 default   | ¤           |     1
 glibc     | ¤           |     4
 glibc     | 2.34        |  1005
 icu       | 153.14      |   461
 icu       | 153.14.39   |   324
(5 rows)
```

Cela permet d'introduire une vérification de la version de la collation
utilisée pour les index dépendant d'une collation spécifique. Un message
d'avertissement est émis lorsque l'on utilise un index dont collation ne
correspond pas à la version disponible actuellement.

```sh
WARNING:  index "t1_pkey" depends on collation "default" version "34.0",
          but the current version is "36.0"
DETAIL:  The index may be corrupted due to changes in sort order.
HINT:  REINDEX to avoid the risk of corruption.
```

La version 15 de PostgreSQL rend possible l'utilisation d'ICU pour gérer les
collations pour l'ensemble de l'instance ou d'une base de données.

Les commandes  `initdb` et `createdb` disposent désormais de deux nouvelles
option `--locale-provider={icu|libc}` et `--icu-locale=LOCALE` pour spécifier
la collation ICU utilisé pour les nouvelles instances.

```bash
initdb --locale-provider=icu --icu-locale=en-US-x-icu \
       --data-checksum /var/lib/postgresql/15/data

createdb --locale-provider=icu --icu-locale=fr-FR-x-icu dbtest
```


Les options `LOCALE_PROVIDER` et `ICU_LOCALE` ont également été ajoutées à la
commande `CREATE DATABASE`.

```sql
CREATE DATABASE dbtest2 
   LOCALE_PROVIDER icu
   ICU_LOCALE "fr-FR-x-icu";
```

</div>
