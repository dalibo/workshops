include:
  - project: 'dalibo/gitlab-templates'
    file: 
      - 'artifacts_public_env.yml'
      - 'artifacts/base.yml'


##
## V A R I A B L E S
##

variables:

  # $ARTIFACTS is required by artefacts_private_env.yml
  ARTIFACTS: '*'  

stages:
  - build
  - deploy

before_script:
  ## Prepare for Deploy Keys
  ## see https://docs.gitlab.com/ee/ci/ssh_keys/README.html#ssh-keys-when-using-the-docker-executor
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - mkdir -p ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config

image:
  # full version required for SVG conversion
  name: dalibo/pandocker:stable 
  entrypoint: [""] # we need to override the image entrypoint


##
## B U I L D
##
pandocker:
  stage: build
  script:
    - make all
    # FIX #197: publish the old artefacts alongside the new ones 
    - rsync --archive _archives/fr/* fr
  artifacts:
    paths:
      - "*"
    expire_in: '1 day'


##
## DEPLOY
##

deploy:private_env:
  extends: .artifacts:deploy_private_env

# This clean up job is mandatory if you extend .artifacts:deploy_private_env
deploy:clean_up_private_env:
  extends: .artifacts:clean_up_private_env

# Override the public deploy job to limit the artifacts
#public_env:
#  variables:
#    ARTEFACTS: "*/*.doc */*.epub */*.html */*.odt */*.pdf"
  # Uncomment to force the job on this branch (for testing purpose)
  #only: null
